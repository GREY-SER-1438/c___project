#include "FuelCompartment2Location-6.h"
#include "Game.h"
#include <iostream>
using namespace std;

void FuelCompartment2Location::run() {
    cout << "\n--- ТОПЛИВНЫЙ ОТСЕК (ЧАСТЬ 2) ---\n\n";

    cout <<
         "Вы входите во второй топливный отсек. Воздух тяжёлый, едкий.\n"
         "Вдалеке, среди обломков, лежит катализатор для ядра.\n"
         "Путь к нему перегорожен массивным обломком топливного бака.\n"
         "Он лежит прямо в луже едкого топлива.\n\n";

    // ---------------------------------------------------------
    // Часть 1: расчистка прохода
    // ---------------------------------------------------------
    cout <<
         "Как действовать?\n"
         "1) Расчистить проход медленно\n"
         "2) Поднять обломок резко и силой (риск)\n";

    int choice = ask({1, 2});
    bool canReachCatalyst = false;
    bool catalystDestroyedEarly = false;

    switch (choice) {
        case 1:
            cout <<
                 "\nВы осторожно, по сантиметру, отодвигаете обломок.\n"
                 "Проход расчищен.\n\n";
            canReachCatalyst = true;
            break;

        case 2: {
            cout << "\nВы пытаетесь резко поднять обломок...\n";
            int r = rand() % 2; // 0 — успех, 1 — провал

            if (r == 0) {
                cout <<
                     "Усилие срабатывает! Вы отбрасываете обломок в сторону.\n"
                     "Проход свободен.\n\n";
                canReachCatalyst = true;
            } else {
                cout <<
                     "Обломок выскальзывает из рук и падает обратно в лужу!\n"
                     "Всплеск едкой жидкости накрывает катализатор.\n"
                     "Он расплавляется на глазах...\n\n";
                catalystDestroyedEarly = true;
            }
            break;
        }
    }

    // ---------------------------------------------------------
    // Часть 2: попытка взять катализатор
    // ---------------------------------------------------------
    bool catalystObtained = false;

    if (!catalystDestroyedEarly && canReachCatalyst) {
        cout <<
             "Подойдя ближе, вы видите: катализатор покрыт едким химическим осадком.\n"
             "Как действовать?\n"
             "1) Взять голыми руками\n";

        bool haveModule = game.fuelCompartment1Location.foundProtectionModule;

        if (haveModule)
            cout << "2) Использовать защитный модуль\n";

        cout << "3) Использовать аварийную продувку\n";

        int choice2 = haveModule ? ask({1, 2, 3}) : ask({1, 3});

        switch (choice2) {
            // --- 1) Голые руки ---
            case 1:
                cout <<
                     "\nВы тянетесь к катализатору... но едкий осадок разъедает кожу.\n"
                     "Вы дёргаете рукой, катализатор падает в лужу и расплавляется.\n\n";
                catalystObtained = false;
                break;

                // --- 2) Защитный модуль ---
            case 2:
                // защита на всякий случай, но мы разрешаем этот выбор только если haveModule == true
                cout <<
                     "\nВы активируете защитный модуль.\n"
                     "Осадок нейтрализован, катализатор теперь безопасен.\n"
                     "Вы аккуратно извлекаете предмет.\n\n";
                catalystObtained = true;
                break;

                // --- 3) Продувка ---
            case 3: {
                cout <<
                     "\nВы включаете панель аварийной продувки.\n"
                     "Какой поток включить?\n"
                     "1) Слабый поток\n"
                     "2) Сильный поток\n";

                int blow = ask({1, 2});

                switch (blow) {
                    case 1:
                        cout <<
                             "\nСлабый поток аккуратно сдувает химический осадок.\n"
                             "Катализатор очищен и безопасен.\n\n";
                        catalystObtained = true;
                        break;

                    case 2:
                        cout <<
                             "\nСильный поток слишком мощный!\n"
                             "Катализатор соскальзывает и падает в лужу топлива.\n"
                             "Он расплавляется.\n\n";
                        catalystObtained = false;
                        break;
                }
                break;
            }
        }
    } else if (catalystDestroyedEarly) {
        // Явное сообщение — катализатор уже уничтожен при неудаче в расчистке
        cout << "Катализатор был уничтожен при попытке убрать обломок. Нет смысла пытаться.\n\n";
    }

    // ---------------------------------------------------------
    // Часть 3: переход к следующей локации (всегда проверяем скафандр)
    // ---------------------------------------------------------
    cout <<
         "Теперь нужно выбрать, как попасть дальше по отсеку.\n"
         "1) Разобрать завал\n";

    bool haveSuit = game.fuelCompartment1Location.foundSpacesuit;

    if (haveSuit)
        cout << "2) Выйти через шлюз в открытый космос (намного быстрее, но очень опасно)\n";

    int exitChoice = haveSuit ? ask({1, 2}) : ask({1});

    switch (exitChoice) {
        case 1:
            cout << "\nВы начинаете разбирать завал.\n";
            if (game.startLocation.tookCrowbar)
                cout << "Лом позволяет работать гораздо быстрее.\n";
            cout << "Через некоторое время путь свободен.\n\n";
            break;

        case 2:
            // (эта ветка возможна только если haveSuit == true)
            cout <<
                 "\nВы надеваете скафандр, герметизируете шлем и открываете шлюз.\n"
                 "Выход в открытый космос — намного быстрее, но очень опасен.\n"
                 "Используя внешние зацепы, вы быстро добираетесь до соседнего отсека.\n\n";
            break;
    }


    // переход в склад
    game.currentLocation = &game.storageLocation;
}