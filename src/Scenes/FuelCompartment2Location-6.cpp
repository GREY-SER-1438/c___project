#include "FuelCompartment2Location-6.h"
#include "Game.h"
#include <iostream>
using namespace std;

void FuelCompartment2Location::run() {
    cout << "\n--- ТОПЛИВНЫЙ ОТСЕК (ЧАСТЬ 2) ---\n\n";

    cout <<
         "Второй отсек выглядит ещё хуже. Воздух тяжёлый, будто давно выстоялся\n"
         "в закрытом, мёртвом помещении. На полу — застывшие подтеки топлива,\n"
         "уже высохшие по краям, словно пролились много дней назад.\n"
         "Среди обломков тускло поблёскивает катализатор.\n\n"
         "Путь к нему перегорожен массивной плитой от разорвавшегося бака.\n"
         "Она вмята в пол под странным углом, словно падала не один раз.\n\n";

    // ---------------------------------------------------------
    // Часть 1: расчистка прохода
    // ---------------------------------------------------------
    cout <<
         "Как действовать?\n"
         "1) Расчистить проход медленно\n"
         "2) Поднять обломок резко и силой (риск)\n";

    int choice = ask({1, 2});
    bool canReachCatalyst = false;
    bool catalystDestroyedEarly = false;

    switch (choice) {
        case 1:
            cout <<
                 "\nВы осторожно отодвигаете плиту, стараясь не задеть лужу.\n"
                 "Металл сухой и холодный, будто отсек давно заброшен.\n"
                 "Проход удалось освободить.\n\n";
            canReachCatalyst = true;
            break;

        case 2: {
            cout << "\nВы резко поднимаете плиту...\n";
            int r = rand() % 2;

            if (r == 0) {
                cout <<
                     "Получилось! Плита падает в сторону, удар отдаётся гулким эхом,\n"
                     "как в пустом, давно не посещаемом отсеке.\n"
                     "Проход свободен.\n\n";
                canReachCatalyst = true;
            } else {
                cout <<
                     "Плита срывается из рук и падает обратно!\n"
                     "Брызги едкой смеси разлетаются, часть попадает на катализатор.\n"
                     "Он начинает плавиться почти мгновенно… словно был изношен заранее.\n\n";
                catalystDestroyedEarly = true;
            }
            break;
        }
    }

    // ---------------------------------------------------------
    // Часть 2: попытка взять катализатор
    // ---------------------------------------------------------

    if (!catalystDestroyedEarly && canReachCatalyst) {
        cout <<
             "Катализатор лежит среди застывшего осадка. Похоже, его уже однажды\n"
             "пытались поднять — на корпусе заметны старые царапины.\n"
             "Как действовать?\n"
             "1) Взять голыми руками\n";

        bool haveModule = game.fuelCompartment1Location.foundProtectionModule;

        if (haveModule)
            cout << "2) Использовать защитный модуль\n";

        cout << "3) Использовать аварийную продувку\n";

        int choice2 = haveModule ? ask({1, 2, 3}) : ask({1, 3});

        switch (choice2) {
            // --- 1) Голые руки ---
            case 1:
                cout <<
                     "\nВы пытаетесь поднять катализатор, но едкий осадок прожигает кожу.\n"
                     "Рефлекторно дёрнув рукой, вы роняете его обратно.\n"
                     "После удара по разъеденному основанию он окончательно рассыпается.\n\n";
                break;

                // --- 2) Защитный модуль ---
            case 2:
                cout <<
                     "\nВы активируете защитный модуль.\n"
                     "Осадок медленно темнеет — реакция нейтрализации прошла успешно.\n"
                     "Катализатор выглядит нетронутым, хотя корпус на ощупь странно тёплый.\n"
                     "Вы забираете его.\n\n";
                game.catalystObtained = true;
                game.inventory.remove("protection");
                game.inventory.add("catalyst");
                break;

                // --- 3) Продувка ---
            case 3: {
                cout <<
                     "\nНа панели продувки мигают старые, потускневшие индикаторы.\n"
                     "Какой режим включить?\n"
                     "1) Слабый поток\n"
                     "2) Сильный поток\n";

                int blow = ask({1, 2});

                switch (blow) {
                    case 1:
                        cout <<
                             "\nСлабый поток аккуратно сдувает осадок.\n"
                             "Катализатор остаётся невредим. Он словно давно ждал этого.\n\n";
                        game.catalystObtained = true;
                        game.inventory.add("catalyst");
                        break;
// todo странно звучит "будто вы слышите это не впервые", заменить
                    case 2:
                        cout <<
                             "\nСильная струя сбивает катализатор в сторону.\n"
                             "Он падает в остатки топлива и начинает плавиться.\n"
                             "Треск металла звучит так, будто вы слышите это не впервые.\n\n";
                        break;
                }
                break;
            }
        }
    } else if (catalystDestroyedEarly) {
        cout <<
             "Катализатор уничтожен — от него осталась лишь мутная лужица.\n"
             "Что бы тут ни произошло раньше, шанс был только один.\n\n";
    }

    // ---------------------------------------------------------
    // Часть 3: переход к следующей локации
    // ---------------------------------------------------------
    cout <<
         "Остаётся решить, как пройти дальше по отсеку.\n"
         "1) Разобрать завал\n";

    bool haveSuit = game.fuelCompartment1Location.foundSpacesuit;

    if (haveSuit)
        cout << "2) Выйти через шлюз в открытый космос (опасно, но быстро)\n";

    int exitChoice = haveSuit ? ask({1, 2}) : ask({1});

    switch (exitChoice) {
        case 1:
            cout <<
                 "\nВы начинаете разбирать завал. Металл ломается легко,\n"
                 "как будто он разрушался не сейчас, а много времени назад.\n";

            if (game.startLocation.tookCrowbar)
                cout << "С ломом работа идёт значительно быстрее.\n";

            cout << "Спустя некоторое время проход освобождён.\n\n";
            break;

        case 2:
            cout <<
                 "\nВы надеваете скафандр и открываете аварийный шлюз.\n"
                 "Снаружи станция выглядит мёртвой: на корпусе следы прогара,\n"
                 "будто вакуум выжёг её медленно, но неотвратимо.\n"
                 "Вы добираетесь до соседнего отсека по внешним зацепам.\n\n";
            enteredViaSpace = true;
            game.inventory.remove("spacesuit");

            break;
    }

    game.currentLocation = &game.storageLocation;
}
