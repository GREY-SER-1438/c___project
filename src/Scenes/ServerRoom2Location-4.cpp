#include "ServerRoom2Location-4.h"
#include "Game.h"
#include <iostream>
using namespace std;

void ServerRoom2Location::run() {
    cout << "\n=== СЕРВЕРНАЯ — СЕКЦИЯ 2 ===\n\n";
    game.currentLocation = &game.fuelCompartment1Location;

    // === ВСТУПИТЕЛЬНЫЙ ТЕКСТ ===

    if (game.serverRoom1Location.usedTerminal) {
        cout <<
             "Вы заходите глубже в серверный отсек. Жар усилился — индикаторы полыхают\n"
             "красным. Предупреждение терминала всплывает в памяти: питание нужно\n"
             "переключить на резервную линию.\n\n";
    } else {
        cout <<
             "Глубинная секция встречает горячим, плотным воздухом. Лампы мигают\n"
             "в беспорядочном ритме — что-то явно пошло не так.\n"
             "Похоже, вся панель питания здесь играет ключевую роль.\n\n";
    }

    // =====================================================================
    // === ВЫБОР 1: ЛИНИЯ ПИТАНИЯ ===
    // =====================================================================

    cout <<
         "Перед вами панель питания: несколько линий, часть перегружена.\n"
         "Как действовать?\n"
         "1) Дёрнуть первый попавшийся рубильник\n"
         "2) Открыть логи системы\n";

    int powerChoice = ask({1, 2});

    if (powerChoice == 1) {
        cout <<
             "\nВы дёргаете рубильник. Вспышка — стойки гаснут.\n"
             "Короткое замыкание окончательно убивает секцию.\n"
             "Жёсткий диск с исследованиями погиб вместе с ней.\n\n";
        return;
    }

    // === Игрок выбрал просмотр логов ===

    cout <<
         "\nВы пролистываете логи: схемы питания, ошибки охлаждения,\n"
         "маршруты обходов. Находите нужную линию и отключаете её аккуратно.\n"
         "Перегретая часть стойки временно обесточена.\n\n";

    // =====================================================================
    // === ВЫБОР 2: ИЗВЛЕЧЕНИЕ ЖЁСТКОГО ДИСКА ===
    // =====================================================================

    cout <<
         "Теперь нужно вытащить жёсткий диск из перегретого блока.\n"
         "Как поступить?\n"
         "1) Попробовать стабилизировать стойку вручную\n"
         "2) Вытащить диск голыми руками\n";

    if (game.serverRoom1Location.foundCoolingModule)
        cout << "3) Вставить охлаждающий модуль\n";

    int secondChoice;

    if (game.serverRoom1Location.foundCoolingModule)
        secondChoice = ask({1, 2, 3});
    else
        secondChoice = ask({1, 2});

    //
    // === ВАРИАНТ: охлаждающий модуль ===
    //
    if (secondChoice == 3) {
        cout <<
             "\nВы вставляете охлаждающий модуль. Температура падает почти сразу.\n"
             "Стойка стабилизируется, и вы спокойно извлекаете диск с данными.\n\n";
        game.hasResearchDisk = true;
        game.inventory.remove("cooling_module");
        game.inventory.add("hard_drive");
        return;
    }

    //
    // === ВАРИАНТ: стабилизация вручную ===
    //
    if (secondChoice == 1) {
        cout <<
             "\nСтойка дрожит, металл горячий. Чтобы удержать её в допуске,\n"
             "нужно перекрыть один из клапанов охлаждения.\n\n"
             "1) Правый клапан\n"
             "2) Левый клапан\n";

        int valveChoice = ask({1, 2});

        if (valveChoice == 1) {
            cout <<
                 "\nВы закрываете правый клапан — вибрация стихает.\n"
                 "Стенки охлаждаются, стойка стабилизирована.\n"
                 "Вы извлекаете диск.\n\n";
            game.hasResearchDisk = true;
            game.inventory.add("hard_drive");
        } else {
            cout <<
                 "\nЛевый клапан перекрыт — стойка резко вздрагивает.\n"
                 "Искры, запах озона. Короткое замыкание.\n"
                 "Диск уничтожен.\n\n";
        }
        return;
    }

    //
    // === ВАРИАНТ: голыми руками ===
    //
    cout <<
         "\nВы тянетесь к диску — металл обжигает, и в тот же момент\n"
         "стойка даёт сильный пробой. Диск сгорает мгновенно.\n\n";
}
