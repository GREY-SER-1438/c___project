#include "StorageLocation-7.h"
#include "Game.h"
#include <iostream>
using namespace std;

void StorageLocation::run() {
    game.currentLocation = &game.coreLocation;
    cout << "\n--- СКЛАДСКОЙ ОТСЕК ---\n\n";

    // ---------------------------------------------
    // Вступительный текст зависит от способа входа
    // ---------------------------------------------
    if (game.fuelCompartment2Location.enteredViaSpace) {
        cout <<
             "Это было опасно, но, выбрав путь через открытый космос, вы всё же\n"
             "добираетесь до складского отсека. Шлюз за вашей спиной захлопывается.\n\n";
    } else {
        cout <<
             "Фух... путь по коридору занял много времени, но вот вы наконец\n"
             "добираетесь до складского отсека.\n\n";
    }

    cout <<
         "Перед вами большое помещение с множеством полок, отсеков и ящиков.\n"
         "В углу стоит холодильник для хранения продуктов.\n"
         "Вся комната залита красным аварийным светом, сирена орёт так, будто\n"
         "вот-вот всё рухнет. Из-под одной из дверей валит густой дым и\n"
         "распространяется запах гари.\n\n";

    cout << "1) Осмотреться\n";
    ask({1});

    cout <<
         "\nВы осматриваетесь. Видно несколько стеллажей с компонентами.\n"
         "Но внезапно вы слышите крик о помощи. Неприятный холодок пробегает по спине.\n"
         "Неужели здесь кто-то живой?.. Или это что-то похуже?\n\n";

    // ---------------------------------------------
    // Первый большой выбор
    // ---------------------------------------------
    cout <<
         "Что делать?\n"
         "1) Проверить дверь, откуда доносится крик\n"
         "2) Осмотреть холодильник\n"
         "3) Осмотреть стеллажи\n";

    int choice1 = ask({1, 2, 3});

    switch (choice1) {

        // -----------------------------------------
        // Проверить дверь
        // -----------------------------------------
        case 1: {
            cout <<
                 "\nПодойдя к двери, вы ощущаете жар. Дым вырывается из всех щелей.\n"
                 "Как поступить?\n"
                 "1) Резко открыть дверь — вдруг там и правда кто-то?\n"
                 "2) Заглянуть в смотровое окно\n";

            int doorChoice = ask({1, 2});

            if (doorChoice == 1) {
                cout <<
                     "\nВы дёргаете дверь...\n"
                     "Из-за перепада давления её распахивает, вырывая поток огня и дыма.\n"
                     "Пожар мгновенно усиливается. Доступ к стеллажам отрезан.\n"
                     "Искать микросхему больше невозможно.\n\n";


                return;
            }

            // doorChoice == 2
            cout <<
                 "\nВы осторожно заглядываете в окно.\n"
                 "Никаких людей не видно — там бушует огонь.\n"
                 "Открывать такую дверь — самоубийство.\n"
                 "Вы возвращаетесь к стеллажам.\n\n";

            break; // продолжаем игру как после выбора 3
        }

            // -----------------------------------------
            // Осмотреть холодильник
            // -----------------------------------------
        case 2:
            cout <<
                 "\nВы подходите к холодильнику. Пока идёте, проходит драгоценное время.\n"
                 "Внутри только продукты, ничего полезного.\n"
                 "Тем временем пожар разгорается так сильно, что путь ко всем стеллажам\n"
                 "становится недоступен. Микросхему уже не найти.\n\n";


            return;

            // -----------------------------------------
            // Осмотреть стеллажи сразу
            // -----------------------------------------
        case 3:
            cout << "\nВы направляетесь к стеллажам.\n\n";
            break; // продолжаем
    }

    // ---------------------------------------------
    // Продолжение локации после 1.2 или 3
    // ---------------------------------------------
    cout <<
         "Перед вами стеллажи трёх типов: механика, гидравлика и электроника.\n\n"
         "Куда направиться?\n"
         "1) Механика\n"
         "2) Гидравлика\n"
         "3) Электроника\n";

    int shelfChoice = ask({1, 2, 3});

    switch (shelfChoice) {

        // --------------------------
        // Механика — пусто
        // --------------------------
        case 1:
            cout <<
                 "\nВы исследуете механический стеллаж, но микросхемы здесь нет.\n"
                 "Пока вы ищете, пожар усиливается. Доступ к остальным стеллажам пропадает.\n"
                 "Нужно уходить.\n\n";


            return;

            // --------------------------
            // Гидравлика — пусто
            // --------------------------
        case 2:
            cout <<
                 "\nВы изучаете гидравлические насосы и трубки.\n"
                 "Ничего похожего на микросхему. Пламя доходит до прохода — пора уходить.\n\n";


            return;

            // --------------------------
            // Электроника — нужный стеллаж
            // --------------------------
        case 3:
            cout <<
                 "\nВы направляетесь к стеллажу с электроникой...\n"
                 "Но прямо перед вами только что обрушился один из стеллажей!\n"
                 "Путь заблокирован. Что делать?\n\n"
                 "1) Аккуратно обходить завал (долго)\n"
                 "2) Перелезть через обломки (опасно, но быстро)\n"
                 "3) Быстро раскидать обломки (50/50)\n";

            int debrisChoice = ask({1, 2, 3});

            if (debrisChoice == 1) {
                cout <<
                     "\nВы аккуратно обходите завал, но теряете слишком много времени.\n"
                     "Пожар уже охватывает стеллаж с электроникой. Микросхему не спасти.\n\n";


                return;
            }

            if (debrisChoice == 2) {
                cout <<
                     "\nВы рискуете и быстро перелезаете через обломки!\n"
                     "Вы успеваете — микросхема найдена!\n\n";

                game.oxygenChipObtained = true;

                return;
            }

            // debrisChoice == 3 — рандом
            {
                int r = rand() % 2; // 0 — успех, 1 — провал

                if (r == 0) {
                    cout <<
                         "\nВы начинаете раскидывать обломки...\n"
                         "И вам везёт! Завал расчищен достаточно быстро.\n"
                         "Вы находите микросхему и поспешно покидаете склад.\n\n";

                    game.oxygenChipObtained = true;
                } else {
                    cout <<
                         "\nВы пытаетесь разгрести завал...\n"
                         "Но обломки оседают ещё сильнее, окончательно блокируя путь.\n"
                         "Добраться до микросхемы больше невозможно.\n\n";
                }


                return;
            }
    }


}
