#include "StorageLocation-7.h"
#include "Game.h"
#include <iostream>
using namespace std;

void StorageLocation::run() {
    game.currentLocation = &game.coreLocation;
    cout << "\n--- СКЛАДСКОЙ ОТСЕК ---\n\n";

    // ---------------------------------------------
    // Вступление — зависит от способа входа
    // ---------------------------------------------
    if (game.fuelCompartment2Location.enteredViaSpace) {
        cout <<
             "Переход через внешний контур оказался безумием, но вы выжили.\n"
             "Шлюз хлопает за спиной, отсекая ледяной вакуум.\n\n";
    } else {
        cout <<
             "Вы продираетесь по задушенному дымом коридору и наконец\n"
             "вваливаетесь в складской отсек.\n\n";
    }

    cout <<
         "Здесь всё охвачено беспорядком: перевёрнутые ящики, разбросанные контейнеры.\n"
         "Красный аварийный свет дробит пространство резкими тенями.\n"
         "Сирена воет без остановки — гул проникает под кожу.\n"
         "Из-за одной из дверей стелится густой дым, пахнет палёным пластиком.\n\n";

    cout << "1) Осмотреться\n";
    ask({1});

    cout <<
         "\nВы делаете шаг вперёд — и звук рвёт тишину.\n"
         "Крик. Человеческий.\n"
         "Настолько отчаянный, что у вас сводит живот.\n"
         "Но в этот момент станции не до чудес: среди огня и хаоса любой звук\n"
         "может оказаться всего лишь эхом катастрофы.\n\n";

    // ---------------------------------------------
    // Первый большой выбор
    // ---------------------------------------------
    cout <<
         "Что делать?\n"
         "1) Проверить дверь, откуда донёсся крик\n"
         "2) Осмотреть холодильник\n"
         "3) Осмотреть стеллажи\n";

    int choice1 = ask({1, 2, 3});


    switch (choice1) {

        // -----------------------------------------
        // Проверить дверь
        // -----------------------------------------
        case 1: {
            cout <<
                 "\nПо мере приближения к двери жар становится всё сильнее.\n"
                 "Дым вырывается из щелей, словно пытаясь вырваться наружу.\n\n"
                 "1) Резко открыть дверь\n"
                 "2) Заглянуть в смотровое окно\n";

            int doorChoice = ask({1, 2});

            if (doorChoice == 1) {
                cout <<
                     "\nВы дёргаете дверь — и давление делает всё остальное.\n"
                     "Полыхающий воздух выбрасывается прямо в вас, усиливая пожар.\n"
                     "Стеллажи отрезаны огнём, путь к микросхеме потерян.\n\n";

                cout << "1) Идти в реакторную. Центр станции ждёт.\n";
                ask({1});
                return;
            }

            // doorChoice == 2
            cout <<
                 "\nВы осторожно заглядываете в маленькое окно.\n"
                 "Там один только огонь. Ни людей, ни движения.\n"
                 "Открывать эту дверь — чистое самоубийство.\n"
                 "Вы отступаете, возвращаясь к стеллажам.\n\n";

            break; // продолжаем как после выбора 3
        }


            // -----------------------------------------
            // Осмотреть холодильник
            // -----------------------------------------
        case 2:
            cout <<
                 "\nВы подходите к холодильнику, теряя секунды — каждая на вес золота.\n"
                 "Внутри только продукты. Ничего нужного.\n"
                 "Пока вы тратите время, пожар захватывает помещение,\n"
                 "отрезая доступ ко всем стеллажам.\n"
                 "Микросхему уже не достать.\n\n";

            cout << "1) Идти в реакторную. Центр станции ждёт.\n";
            ask({1});
            return;


            // -----------------------------------------
            // Осмотреть стеллажи сразу
            // -----------------------------------------
        case 3:
            cout << "\nВы направляетесь к стеллажам.\n\n";
            break;
    }


    // ---------------------------------------------
    // Продолжение — выбор стеллажей
    // ---------------------------------------------
    cout <<
         "Перед вами три стеллажа: механика, гидравлика и электроника.\n\n"
         "К какому подойти?\n"
         "1) Механика\n"
         "2) Гидравлика\n"
         "3) Электроника\n";

    int shelfChoice = ask({1, 2, 3});


    switch (shelfChoice) {

        // --------------------------
        // Механика — пусто
        // --------------------------
        case 1:
            cout <<
                 "\nВы перебираете инструменты и узлы, но микросхемы здесь нет.\n"
                 "Тем временем пожар набирает силу, перекрывая остальные проходы.\n"
                 "Нужно уходить, пока не стало хуже.\n\n";

            cout << "1) Идти в реакторную. Центр станции ждёт.\n";
            ask({1});
            return;


            // --------------------------
            // Гидравлика — пусто
            // --------------------------
        case 2:
            cout <<
                 "\nВы проверяете насосы, клапаны, трубные сегменты.\n"
                 "Полезного ничего.\n"
                 "Пламя уже вплотную, возвращаться поздно — только вперёд.\n\n";

            cout << "1) Идти в реакторную. Центр станции ждёт.\n";
            ask({1});
            return;


            // --------------------------
            // Электроника — нужный стеллаж
            // --------------------------
        case 3:
            cout <<
                 "\nВы подходите к электронной секции...\n"
                 "И тут один из стеллажей падает, обрушиваясь прямо перед вами.\n"
                 "Проход завален. Нужно решать быстро.\n\n"
                 "1) Аккуратно обходить завал (безопасно, но медленно)\n"
                 "2) Перелезть через обломки (опасно, но быстро)\n"
                 "3) Быстро разгрести завал\n";

            int debrisChoice = ask({1, 2, 3});

            // 1) долго — провал
            if (debrisChoice == 1) {
                cout <<
                     "\nВы стараетесь идти безопасным путём...\n"
                     "но тратите слишком много времени.\n"
                     "Пламя добирается до стеллажа с электроникой — всё пропало.\n\n";

                cout << "1) Идти в реакторную. Центр станции ждёт.\n";
                ask({1});
                return;
            }

            // 2) риск — успех
            if (debrisChoice == 2) {
                cout <<
                     "\nВы решаетесь и перелезаете через металлические обломки.\n"
                     "Пара секунд — и вы у полок.\n"
                     "Микросхема найдена.\n\n";

                game.oxygenChipObtained = true;
                game.inventory.add("oxygen_chip");
                cout << "1) Идти в реакторную. Центр станции ждёт.\n";
                ask({1});
                return;
            }

            // 3) 50/50
            {
                int r = rand() % 2;

                if (r == 0) {
                    cout <<
                         "\nВы яростно разбрасываете обломки.\n"
                         "Повезло — проход открыт достаточно быстро!\n"
                         "Микросхема у вас.\n\n";

                    game.oxygenChipObtained = true;
                    game.inventory.add("oxygen_chip");
                } else {
                    cout <<
                         "\nВы пытаетесь расчищать завал...\n"
                         "Но конструкция оседает ещё больше, окончательно блокируя путь.\n"
                         "Микросхему уже не достать.\n\n";
                }

                cout << "1) Идти в реакторную. Центр станции ждёт.\n";
                ask({1});
                return;
            }
    }
}
